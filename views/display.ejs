<head>
    <script src="../cytoscape.min.js"></script>
    <script src="https://unpkg.com/layout-base/layout-base.js"></script>
    <script src="https://unpkg.com/cose-base/cose-base.js"></script>
    <script src="https://unpkg.com/cytoscape-fcose/cytoscape-fcose.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>

</head>

<style>
    #cy {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0px;
        left: 0px;
    }

    #contextMenu {
        display: none;
        position: absolute;
        z-index: 1000;
        background: white;
        border: 1px solid black;
        padding: 10px;
    }

    #contextMenu ul {
        list-style: none; /* Remove bullet points */
        margin: 0;
        padding: 0;
    }

    #contextMenu li {
        padding: 5px 10px;
        color: black; 
        cursor: pointer;
    }

    #contextMenu li:hover {
        background-color: #f0f0f0; /* Visual feedback on hover */
    }
</style>

<body>
    <form id="actorForm" label="Actor Form" method="post">
        <input type="text" name="actor" placeholder="Actor Name" required>
        <input type="number" name="depth" placeholder="Depth" required>
        <button type="submit">Submit</button>
    </form>

    <div id="contextMenu" style="display: none; position: absolute; z-index: 10; background: white; border: 1px solid black; padding: 10px;">
        <ul>
            <li id="showMovies" style="display: none;">Show movies</li>
            <li id="showActors" style="display: none;">Show actors</li>
        </ul>
    </div>

    <div id="cy"></div>

    <script type="module">
             var layoutOptions = {
                name: 'fcose',
                animate: true,
                fit: true,
                padding: 50,
                nodeSeparation: 100,
            };

            var cy = cytoscape(
                { 
                    container: document.getElementById("cy"), 
                    selectionType: 'additive',
                    boxSelectionEnabled: true,
                    style: [
                    {
                        selector: 'node[type = "Movie"]',
                        css: {
                            'label': 'data(properties.title)',
                            'height': '50px',
                            'width': '50px',
                            'background-image': 'url(../Film.png)', 
                            'background-fit': 'cover',
                            'text-opacity': 0.8,

                        }
                    },
                    
                    {
                        selector: 'node[type = "Person"]',
                        css: {
                            'label': 'data(properties.name)',
                            'background-image': 'url(../Person-1.png)', 
                            'background-fit': 'cover',
                            'text-opacity': 0.8,

                        }
                    },
                    
                    { selector: "edge[label]", 
                        css: { 
                            "label": "data(type)",
                            "text-rotation": "autorotate",
                            'text-opacity': 0.8,
                            'font-size':'10px',
                            'font-weight': 'bold',
                            'line-color': '#FDDA0D',
                            'width': '3px',
                            'curve-style': 'bezier', 
                            'control-point-step-size': 20, 
                            // Ensure the arrow is visible
                            'target-arrow-shape': 'triangle',
                            'target-arrow-color': '#FDDA0D', 
                            } 
                    }, 

                ], 
                }
            );
            
            cy.on('cxttap', 'node', function(event) {
                var node = event.target;
                var renderedPosition = node.renderedPosition();

                // Determine whether it's an actor or a movie node
                var isActor = node.data('type') === 'Person';
                var isMovie = node.data('type') === 'Movie';

                // Show/hide menu items based on node type
                document.getElementById('showMovies').style.display = isActor ? 'block' : 'none';
                document.getElementById('showActors').style.display = isMovie ? 'block' : 'none';

                // Position and display the context menu
                var contextMenu = document.getElementById('contextMenu');
                contextMenu.style.display = 'block';
                contextMenu.style.left = renderedPosition.x + 'px';
                contextMenu.style.top = renderedPosition.y + 'px';

                // Event listener for "Show movies"
                document.getElementById('showMovies').onclick = function() {
                    fetchMovies(node.id());
                };

                // Event listener for "Show actors"
                document.getElementById('showActors').onclick = function() {
                    fetchActors(node.id());
                };
            });

            // Hide the context menu on graph tap
            cy.on('tap', function(event) {
                document.getElementById('contextMenu').style.display = 'none';
            });

            function fetchMovies(actorId) {
            //create a post request to addActorMovies
            //update the graph with the received data
                $.ajax({
                    type: "POST",
                    url: "/addActorMovies",
                    data: {actorId: actorId},
                    success: function(data) {
                        addDataToCytoscape(dataArr)
                        console.log(dataArr);
                    }
                });
            }

            function fetchActors(movieId) {
                // AJAX call to fetch actors for the movie
                // Example URL: '/getActors?movieId=' + movieId
                // Update the graph with the received data
            }
            
            
            // Pass data from server to client and add to cytoscape
            function addDataToCytoscape(dataArr) {
                console.log(dataArr);
                //remove nodes
                cy.remove('node')
                cy.add(dataArr);
                cy.layout(layoutOptions).run();
            }
            
            //document.addEventListener('DOMContentLoaded', function() {
            //    var form = document.getElementById('actorForm'); 
            //    if (form) {
            //        form.onsubmit = function(e) {
            //            console.log('Form submitted');
            //            var actor = document.querySelector('[name="actor"]').value;
            //            var depth = document.querySelector('[name="depth"]').value;
//
            //            var formData = { actor: actor, depth: depth };
//
            //            // Make an AJAX call to the server
            //            fetch('/actor/depth', {
            //                method: 'POST',
            //                headers: {
            //                    'Content-Type': 'application/json'
            //                },
            //                body: JSON.stringify(formData)
            //            })
            //            .then(response => response.json())
            //            .then(dataArr => {
            //                console.log('Success:', dataArr);
            //                addDataToCytoscape(dataArr);
            //            })
            //            .catch(error => console.error('Error:', error));
            //        };
            //    }
            //});

            var dataArr = <%- JSON.stringify(dataArr)  %>;
            addDataToCytoscape(dataArr);

    </script>




</body>